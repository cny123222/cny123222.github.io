

<!DOCTYPE html>
<html lang="en" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">

  <link rel="apple-touch-icon" sizes="76x76" href="/img/fluid.png">
  <link rel="icon" href="/img/fluid.png">
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="Nuoyan Chen">
  <meta name="keywords" content="">
  
    <meta name="description" content="这是《操作系统》SJTU-CS3601 课程的课程笔记系列。本文整理部分为“第 2 部分：内存管理”。">
<meta property="og:type" content="article">
<meta property="og:title" content="操作系统 SJTU 版(2)：内存管理">
<meta property="og:url" content="https://cny123222.github.io/2025/10/21/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-SJTU-%E7%89%88-2-%EF%BC%9A%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/index.html">
<meta property="og:site_name" content="Nuoyan Chen&#39;s Blog">
<meta property="og:description" content="这是《操作系统》SJTU-CS3601 课程的课程笔记系列。本文整理部分为“第 2 部分：内存管理”。">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="https://cny123222.github.io/img/os-new.png">
<meta property="article:published_time" content="2025-10-21T15:48:21.000Z">
<meta property="article:modified_time" content="2025-10-23T06:52:54.770Z">
<meta property="article:author" content="Nuoyan Chen">
<meta property="article:tag" content="操作系统">
<meta property="article:tag" content="课程笔记">
<meta property="article:tag" content="知识点整理">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://cny123222.github.io/img/os-new.png">
  
  
    <meta name="referrer" content="no-referrer-when-downgrade">
  
  
  <title>操作系统 SJTU 版(2)：内存管理 - Nuoyan Chen&#39;s Blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/KaTeX/0.16.2/katex.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1749284_5i9bdhy70f8.css">



<link rel="stylesheet" href="//at.alicdn.com/t/c/font_1736178_k526ubmyhba.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"cny123222.github.io","root":"/","version":"1.9.8","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":true},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":3},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":false,"follow_dnt":true,"baidu":null,"google":{"measurement_id":null},"tencent":{"sid":null,"cid":null},"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false},"umami":{"src":null,"website_id":null,"domains":null,"start_time":"2024-01-01T00:00:00.000Z","token":null,"api_server":null}},"search_path":"/local-search.xml","include_content_in_search":true};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>
  


  
<meta name="generator" content="Hexo 7.3.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 80vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Nuoyan Chen&#39;s Blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/" target="_self">
                <i class="iconfont icon-home-fill"></i>
                <span>Home</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/" target="_self">
                <i class="iconfont icon-archive-fill"></i>
                <span>Archives</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/" target="_self">
                <i class="iconfont icon-category-fill"></i>
                <span>Categories</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/tags/" target="_self">
                <i class="iconfont icon-tags-fill"></i>
                <span>Tags</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/" target="_self">
                <i class="iconfont icon-user-fill"></i>
                <span>About</span>
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/links/" target="_self">
                <i class="iconfont icon-link-fill"></i>
                <span>Links</span>
              </a>
            </li>
          
        
        
          <li class="nav-item" id="search-btn">
            <a class="nav-link" target="_self" href="javascript:;" data-toggle="modal" data-target="#modalSearch" aria-label="Search">
              <i class="iconfont icon-search"></i>
            </a>
          </li>
          
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">
              <i class="iconfont icon-dark" id="color-toggle-icon"></i>
            </a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('/img/nanjing.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.4)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="操作系统 SJTU 版(2)：内存管理"></span>
          
        </div>

        
          
  <div class="mt-3">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-author" aria-hidden="true"></i>
        Nuoyan Chen
      </span>
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2025-10-21 23:48" pubdate>
          October 21, 2025 pm
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          2.9k words
        
      </span>
    

    
      <span class="post-meta mr-2">
        <i class="iconfont icon-clock-fill"></i>
        
        
        
          25 mins
        
      </span>
    

    
    
      
        <span id="busuanzi_container_page_pv" style="display: none">
          <i class="iconfont icon-eye" aria-hidden="true"></i>
          <span id="busuanzi_value_page_pv"></span> views
        </span>
        

      
    
  </div>


        
      </div>

      
        <div class="scroll-down-bar">
          <i class="iconfont icon-arrowdown"></i>
        </div>
      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar category-bar" style="margin-right: -1rem">
    





<div class="category-list">
  
  
    
    
    
    <div class="category row nomargin-x">
      <a class="category-item 
          list-group-item category-item-action col-10 col-md-11 col-xm-11" title="操作系统"
        id="heading-30d23ef4f49e85f37f54786ff984032c" role="tab" data-toggle="collapse" href="#collapse-30d23ef4f49e85f37f54786ff984032c"
        aria-expanded="true"
      >
        操作系统
        <span class="list-group-count">(7)</span>
        <i class="iconfont icon-arrowright"></i>
      </a>
      
      <div class="category-collapse collapse show" id="collapse-30d23ef4f49e85f37f54786ff984032c"
           role="tabpanel" aria-labelledby="heading-30d23ef4f49e85f37f54786ff984032c">
        
        
          
  <div class="category-post-list">
    
    
      
      
        <a href="/2025/10/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-SJTU-%E7%89%88-1-%EF%BC%9A%E6%A6%82%E8%BF%B0/" title="操作系统 SJTU 版(1)：概述"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">操作系统 SJTU 版(1)：概述</span>
        </a>
      
    
      
      
        <a href="/2025/10/21/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-SJTU-%E7%89%88-2-%EF%BC%9A%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86/" title="操作系统 SJTU 版(2)：内存管理"
           class="list-group-item list-group-item-action
           active">
          <span class="category-post">操作系统 SJTU 版(2)：内存管理</span>
        </a>
      
    
      
      
        <a href="/2025/06/13/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-1-%EF%BC%9A%E6%A6%82%E8%BF%B0/" title="操作系统(1)：概述"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">操作系统(1)：概述</span>
        </a>
      
    
      
      
        <a href="/2025/06/18/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-2-%EF%BC%9A%E5%A4%84%E7%90%86%E6%9C%BA%E7%AE%A1%E7%90%86/" title="操作系统(2)：处理机管理"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">操作系统(2)：处理机管理</span>
        </a>
      
    
      
      
        <a href="/2025/07/11/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-3-%EF%BC%9A%E5%AD%98%E5%82%A8%E5%99%A8%E7%AE%A1%E7%90%86/" title="操作系统(3)：存储器管理"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">操作系统(3)：存储器管理</span>
        </a>
      
    
      
      
        <a href="/2025/07/17/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-4-%EF%BC%9A%E6%96%87%E4%BB%B6%E7%AE%A1%E7%90%86/" title="操作系统(4)：文件管理"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">操作系统(4)：文件管理</span>
        </a>
      
    
      
      
        <a href="/2025/07/18/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-5-%EF%BC%9AI-O%E7%AE%A1%E7%90%86/" title="操作系统(5)：I/O管理"
           class="list-group-item list-group-item-action
           ">
          <span class="category-post">操作系统(5)：I/O管理</span>
        </a>
      
    
  </div>

        
      </div>
    </div>
  
</div>


  </aside>


    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <h1 id="seo-header">操作系统 SJTU 版(2)：内存管理</h1>
            
              <p id="updated-time" class="note note-default" style="">
                
                  
                    Last updated on October 23, 2025 pm
                  
                
              </p>
            
            
              <div class="markdown-body">
                
                <p>这是《操作系统》SJTU-CS3601 课程的课程笔记系列。本文整理部分为“第 2 部分：内存管理”。</p>
<span id="more"></span>
<h2 id="Lecture-5-内存地址翻译">Lecture 5: 内存地址翻译</h2>
<h3 id="内存管理">内存管理</h3>
<ul>
<li><strong>地址映射</strong>：由 CPU 中的 <strong>MMU</strong>（Memory Management Unit）将虚拟地址翻译为物理地址，由操作系统配置如何翻译</li>
<li><strong>分页机制</strong>：虚拟页和物理页的页长相等
<ul>
<li><strong>虚拟地址（VA）</strong>：虚拟页偏移（VPO）+ 虚拟页号（VPN）</li>
<li><strong>物理地址（PA）</strong>：物理页偏移（PPO）+ 物理页号（PPN）</li>
</ul>
</li>
<li><strong>页表</strong>：记录虚拟页号到物理页号的映射
<ul>
<li>每个进程一张页表，操作系统也有一张页表</li>
<li>包含多个页表项，存储物理页的页号（虚拟页号为索引）</li>
<li>存储在物理内存中，由 OS 负责维护</li>
<li>其起始地址存放在页表基地址寄存器中</li>
</ul>
</li>
<li><strong>分页机制的特点</strong>：
<ul>
<li>物理内存离散分配
<ul>
<li>任意虚拟页可以映射到任意物理页</li>
<li>大大降低对物理内存连续性的要求</li>
</ul>
</li>
<li>主存资源易于管理，利用率更高
<ul>
<li>按照固定页大小分配物理内存</li>
<li>能大大降低外部碎片和内部碎片</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="多级页表">多级页表</h3>
<ul>
<li><strong>多级页表的优点</strong>：能有效压缩页表的大小
<ul>
<li><strong>原因</strong>：允许页表中出现空洞
<ul>
<li>若某个页表页中的某个页表项为空，那么其对应的下一级页表页便无需存在</li>
<li>应用程序的虚拟地址空间大部分都未分配</li>
</ul>
</li>
</ul>
</li>
<li><strong>页表格式</strong>：AARCH64 体系结构下 4 级页表
<ul>
<li>每个页表页占用一个 4K 物理页</li>
<li>每个页表项占用 8 个字节，每个页表页有 512 个页表项</li>
</ul>
</li>
</ul>
<p><img src="multi_page_table.png" srcset="/img/loading.gif" lazyload alt=""></p>
<ul>
<li><strong>64 位虚拟地址解析</strong>:
<ul>
<li>[63:48] 16-bit：必须全 0 或全 1
<ul>
<li>一般应用程序地址是 0，内核地址是 1</li>
<li>意味着虚拟地址空间大小最大是 <span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msup><mn>2</mn><mn>48</mn></msup></mrow><annotation encoding="application/x-tex">2^{48}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.8141em;"></span><span class="mord"><span class="mord">2</span><span class="msupsub"><span class="vlist-t"><span class="vlist-r"><span class="vlist" style="height:0.8141em;"><span style="top:-3.063em;margin-right:0.05em;"><span class="pstrut" style="height:2.7em;"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mord mtight">48</span></span></span></span></span></span></span></span></span></span></span></span> Byte，即 256 TB</li>
</ul>
</li>
<li>[47:39] 9-bit：0 级页表索引</li>
<li>[38:30] 9-bit：1 级页表索引</li>
<li>[29:21] 9-bit：2 级页表索引</li>
<li>[20:12] 9-bit：3 级页表索引</li>
<li>[11:0] 12-bit：页内偏移</li>
</ul>
</li>
<li><strong>页表基地址寄存器</strong>：AARCH64 有两个页表基地址寄存器：TTBR0_EL1 和 TTBR1_EL1
<ul>
<li>MMU 根据虚拟地址第 63 位选择使用哪一个</li>
<li>以 Linux 为例，应用程序（地址首位为 0）使用 TTBR0_EL1，操作系统（地址首位为 1）使用 TTBR1_EL1</li>
</ul>
</li>
<li><strong>页表使能</strong>：
<ul>
<li>机器上电会先进入物理寻址模式，系统软件需配置控制寄存器使能页表从而进入虚拟寻址模式</li>
<li>AARCH64 在 SCTLR_EL1 第 0 位（M 位）置 1，即在 EL0 和 EL1 权限级使能页表</li>
</ul>
</li>
</ul>
<h3 id="页表项">页表项</h3>
<ul>
<li><strong>页表页</strong>：
<ul>
<li>每级页表有若干离散的页表页，每个页表页占用一个物理页</li>
<li>第 0 级页表有且仅有一个页表页，页表基地址寄存器存储的就是该页的物理地址</li>
<li>每个页表页中有 512 个页表项，每项为 8 个字节，用于存储物理地址和权限</li>
</ul>
</li>
<li><strong>页表项中的属性位</strong>：
<ul>
<li><strong>页描述符 / 表描述符</strong>：PFN，即物理页号
<ul>
<li>页描述符指向 4K 页，表描述符指向下一级页表</li>
</ul>
</li>
<li><strong>有效位(V)</strong>：有效位，当访问时 V=0，则触发缺页异常</li>
<li>对于 3 级页表项，还有各种权限位、访问位、脏位等</li>
</ul>
</li>
<li><strong>大页</strong>：中间级的页表项也能够直接指向物理页
<ul>
<li><strong>块描述符</strong>：指向大页</li>
<li>有效的 0-2 级页表项，第 1 位为 0 表示 PFN 指向大页，第 1 位为 1 表示 PFN 指向下一级页表</li>
</ul>
</li>
</ul>
<p><img src="big_page.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h3 id="TLB：缓存页表项">TLB：缓存页表项</h3>
<ul>
<li><strong>多级页表的优缺点</strong>：用时间换空间
<ul>
<li><strong>优点</strong>：压缩页表大小</li>
<li><strong>缺点</strong>：增加了访存次数（逐级查询）</li>
</ul>
</li>
<li><strong>TLB</strong>：Translation Lookaside Buffer
<ul>
<li>位于 CPU 内部，是页表的缓存</li>
<li>缓存了虚拟页号到物理页号的映射关系</li>
<li>在地址翻译过程中，MMU 首先查询 TLB</li>
</ul>
</li>
<li><strong>TLB 命中</strong>：不再查询页表，可以减少查询页表带来的访存次数</li>
<li><strong>TLB 不命中</strong>：再查询页表，会导致额外的访存</li>
<li><strong>TLB 查询</strong>：
<ul>
<li>虚拟页号分为 TLBI（TLB index）+ TLBT（TLB tag）</li>
<li>先用 index 找到一个 set，再对比其中 entry 的 tag</li>
</ul>
</li>
<li><strong>TLB 刷新</strong>：当 OS 切换进程页表时，TLB 需要全部刷新
<ul>
<li>在用户和内核之间切换时，不需要刷新 TLB</li>
</ul>
</li>
<li><strong>降低 TLB 刷新的开销</strong>：ASID（Address Space ID）
<ul>
<li>OS 为不同进程分配 8 位或 16 位 ASID
<ul>
<li>OS 负责将 ASID 填写在 TTBR0_EL1 的高 8 位或高 16 位</li>
</ul>
</li>
<li>TLB 的每一项也会缓存 ASID
<ul>
<li>地址翻译时，硬件会将 TLB 项的 ASID 与 TTBR0_EL1 的 ASID 对比</li>
<li>使用了 ASID 之后，切换页表（即切换进程）后，不再需要刷新 TLB，提高性能</li>
<li>修改页表映射后，仍需刷新 TLB</li>
</ul>
</li>
</ul>
</li>
<li><strong>TLB 与多核</strong>：OS 修改页表后，需要根据进程调度信息，刷新其它核的 TLB</li>
</ul>
<h3 id="小结：虚拟内存机制的优势">小结：虚拟内存机制的优势</h3>
<ul>
<li><strong>高效使用物理内存</strong>：使用 DRAM 作为虚拟地址空间的缓存</li>
<li><strong>简化内存管理</strong>：每个进程看到的是统一的线性地址空间</li>
<li><strong>更强的隔离与更细的权限控制</strong>：
<ul>
<li>一个进程不能访问属于其他进程的内存</li>
<li>用户程序不能够访问特权更高的内核信息</li>
<li>不同内存页的读、写、执行权限可以不同</li>
<li>可在不同进程之间共享内存（不同虚拟地址空间的虚拟内存页映射到相同的物理页）</li>
</ul>
</li>
</ul>
<h2 id="Lecture-6-系统初始化">Lecture 6: 系统初始化</h2>
<h3 id="启动过程与系统初始化">启动过程与系统初始化</h3>
<p><img src="init.png" srcset="/img/loading.gif" lazyload alt=""></p>
<ul>
<li><strong>从计算机上电到内核开始运行</strong>：
<ul>
<li>
<ol>
<li>上电后，开始执行 BIOS ROM 中的代码（早期设备）</li>
</ol>
<ul>
<li>自检，然后找到第一个可启动设备（如第一块磁盘）</li>
<li>将可启动设备的第一个块加载到内存固定地址中</li>
<li>跳转到 bootloader 的内存地址并继续执行</li>
</ul>
</li>
<li>
<ol start="2">
<li>bootloader 开始执行</li>
</ol>
<ul>
<li>将内核的二进制文件从启动设备加载到内存中</li>
<li>若内核文件是压缩包，则对其进行解压</li>
<li>跳转到（解压后的）内核加载地址（物理地址）并继续执行</li>
</ul>
</li>
<li>
<ol start="3">
<li>内核代码开始执行</li>
</ol>
</li>
</ul>
</li>
<li><strong>内核启动的 3 个主要任务</strong>：
<ul>
<li>设置 CPU 异常级别（特权级别）为 EL1</li>
<li>设置页表并开启虚拟内存机制</li>
<li>设置异常向量表</li>
</ul>
</li>
</ul>
<h3 id="物理地址空间">物理地址空间</h3>
<ul>
<li><strong>物理地址空间</strong>：系统总线地址空间
<ul>
<li>系统总线连接内存，也连接其他设备，每个设备都占一块地址空间</li>
</ul>
</li>
</ul>
<h3 id="课程实验内核启动">课程实验内核启动</h3>
<ul>
<li>
<p><strong>内核的加载</strong>：bootloader 将内核代码放在某一低地址处，该地址由内核在编译时显式给出</p>
</li>
<li>
<p><strong>内核运行的初始代码</strong>：</p>
<ul>
<li>设置当前 EL 为 EL1</li>
<li>设置启动时用的栈，跳转到 C 代码</li>
<li>初始化页表…</li>
</ul>
</li>
</ul>
<p><img src="init_code.png" srcset="/img/loading.gif" lazyload alt=""></p>
<ul>
<li><strong>由 EL3 进入 EL1</strong>：由 <code>eret</code> 返回，同时写入 ELR 及 SPSR 中准备好的 PC 及特权级</li>
</ul>
<p><img src="el1.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h3 id="页表初始化">页表初始化</h3>
<ul>
<li><strong>页表初始化的过程</strong>：
<ul>
<li>设置 TTBR0 页表：将低地址虚拟内存映射到物理内存，使当前低地址代码能正常运行</li>
<li>设置 TTBR1 页表：将高地址虚拟内存映射到物理内存，使得内核能切换到高地址运行</li>
<li>将页表的物理地址写入 TTBR0 和 TTBR1
<ul>
<li>TTBR0_EL1：虚拟地址 = 物理地址</li>
<li>TTBR1_EL1：虚拟地址 = 物理地址 + OFFSET</li>
</ul>
</li>
<li>将 SCTLR_EL1 的某些位置 1，开启页表</li>
</ul>
</li>
</ul>
<p><img src="memory.png" srcset="/img/loading.gif" lazyload alt=""></p>
<h3 id="异常向量表初始化">异常向量表初始化</h3>
<ul>
<li><strong>异常向量表初始化的过程</strong>：将异常向量表基地址写入 VBAR_EL1</li>
<li><strong>异常向量表</strong>：每个异常向量表项跳转到对应的异常处理函数</li>
<li><strong>异常处理函数</strong>：处理异常前保存进程上下文，返回进程前恢复其上下文</li>
</ul>
<h2 id="Lecture-7-操作系统管理页表映射">Lecture 7: 操作系统管理页表映射</h2>
<ul>
<li><strong>设置页表映射的时机</strong>：
<ul>
<li><strong>操作系统自己使用的页表</strong>：在启动时填写，映射全部物理内存
<ul>
<li><strong>直接映射</strong>：虚拟地址 = 物理地址 + 固定偏移</li>
</ul>
</li>
<li><strong>应用进程的页表</strong>：操作系统填写进程页表的一种策略
<ul>
<li><strong>立即映射</strong>：创建进程时，OS 按照虚拟内存区域填写进程页表
<ul>
<li>步骤1：分配物理页（alloc_page）</li>
<li>步骤2：把应用代码/数据从磁盘加载到物理页中</li>
<li>步骤3：添加虚拟页到物理页的映射（add_mapping）</li>
<li>步骤4：未加载完毕，回到步骤1</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><strong>分配物理页的简单实现</strong>：操作系统用位图（Bitmap）记录物理页是否空闲
<ul>
<li>0：空闲；1：已分配</li>
</ul>
</li>
<li><strong>操作系统填写进程页表</strong>：在进程结构体中保存页表基地址</li>
</ul>
<p><img src="add_mapping.png" srcset="/img/loading.gif" lazyload alt=""></p>
<p><img src="get_next_pt.png" srcset="/img/loading.gif" lazyload alt=""></p>
<ul>
<li><strong>立即映射的弊端</strong>：物理内存资源浪费、非必要时延</li>
</ul>
<h3 id="延迟映射">延迟映射</h3>
<ul>
<li><strong>解决立即映射弊端的思路</strong>：操作系统<strong>按进程实际需要</strong>分配物理页和填写页表，避免分配的物理页实际不被用到的情况</li>
<li><strong>延迟映射的主要思路</strong>：解耦虚拟内存分配与物理内存分配
<ul>
<li>先记录下为进程分配的虚拟内存区域</li>
<li>当进程实际访问某个虚拟页时，CPU 会触发缺页异常</li>
<li>操作系统在缺页异常处理函数中添加映射</li>
</ul>
</li>
<li><strong>OS 区分合法/非法缺页异常</strong>：操作系统记录为进程分配的虚拟内存区域
<ul>
<li>访问非法虚拟地址，会触发 CPU 异常；操作系统处理该异常时，选择报错：segfault</li>
<li><strong>合法虚拟地址信息的记录方式</strong>：Linux 中对应 vm_area_struct（VMA）结构体</li>
</ul>
</li>
</ul>
<p><img src="vma.png" srcset="/img/loading.gif" lazyload alt=""></p>
<ul>
<li><strong>VMA 的添加方式</strong>：
<ul>
<li><strong>途径1</strong>：OS 在创建进程时分配
<ul>
<li>数据（对应 ELF 文件的数据段）</li>
<li>代码（对应 ELF 文件的代码段）</li>
<li>栈（初始无内容）</li>
</ul>
</li>
<li><strong>途径2</strong>：进程运行时添加 / 应用程序主动向 OS 发起系统调用
<ul>
<li>堆、栈</li>
<li><strong><code>mmap</code></strong>：
<ul>
<li>申请空的虚拟内存区域</li>
<li>申请映射文件数据的虚拟内存区域</li>
</ul>
</li>
<li><strong><code>brk()</code></strong>：扩大、缩小堆区域</li>
<li><strong>栈 VMA 的可选策略</strong>：OS 为进程初始分配固定大小的栈 VMA，在发现 stackoverflow 之后自动扩大栈 VMA</li>
<li><strong>用户态的 <code>malloc</code>（API）也可能改变 VMA</strong>：
<ul>
<li>调用 <code>brk</code> 在堆中分配新的内存</li>
<li>调用 <code>mmap</code> 分配较大区域</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><strong><code>mmap</code></strong>：分配一段虚拟内存区域
<ul>
<li>通常用于把一个文件（或一部分）映射到内存</li>
<li>也可以不映射任何文件，仅仅新建虚拟内存区域（匿名映射）</li>
</ul>
</li>
<li><strong>根据 VMA 判断缺页异常的合法性</strong>:
<ul>
<li><strong>缺页异常</strong>：触发同步异常
<ul>
<li>根据 ESR 信息判断是否为缺页异常</li>
<li>访问的虚拟地址存放在 FAR_EL1</li>
</ul>
</li>
<li><strong>操作系统的缺页处理函数</strong>：
<ul>
<li>FAR_EL1 中的值不落在 VMA 区域内，则为非法</li>
<li>反之，则分配物理页，并在页表中添加映射</li>
</ul>
</li>
</ul>
</li>
<li><strong>延迟映射的优缺点</strong>：
<ul>
<li><strong>优势</strong>：节约内存资源</li>
<li><strong>劣势</strong>：缺页异常导致访问延迟增加</li>
<li><strong>取得平衡的方式</strong>：
<ul>
<li>应用程序访存具有时空局部性（Locality）</li>
<li>在缺页异常处理函数中采用<strong>预先映射</strong>的策略，即节约内存又能减少缺页异常次数</li>
</ul>
</li>
</ul>
</li>
<li><strong>OS 可向应用提供灵活的内存管理系统调用</strong>：
<ul>
<li><strong><code>madvise</code></strong>：将用户态的一些语义信息发给内核以便于优化
<ul>
<li>将 <code>madvise</code> 和 <code>mmap</code> 搭配，在使用数据前告诉内核这一段数据需要使用，建议 OS 提前分配物理页，减少缺页异常开销</li>
</ul>
</li>
<li><strong><code>mprotect</code></strong>：改变一段内存的权限</li>
</ul>
</li>
</ul>
<h3 id="虚拟内存的扩展功能">虚拟内存的扩展功能</h3>
<h2 id="参考资料">参考资料</h2>
<p>本文参考上海交通大学并行与分布式系统研究所（IPADS）操作系统课程 CS3601 华志超老师的 PPT 课件整理。</p>

                
              </div>
            
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" class="category-chain-item">操作系统</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
    <div class="post-meta">
      <i class="iconfont icon-tags"></i>
      
        <a href="/tags/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F/" class="print-no-link">#操作系统</a>
      
        <a href="/tags/%E8%AF%BE%E7%A8%8B%E7%AC%94%E8%AE%B0/" class="print-no-link">#课程笔记</a>
      
        <a href="/tags/%E7%9F%A5%E8%AF%86%E7%82%B9%E6%95%B4%E7%90%86/" class="print-no-link">#知识点整理</a>
      
    </div>
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>操作系统 SJTU 版(2)：内存管理</div>
      <div>https://cny123222.github.io/2025/10/21/操作系统-SJTU-版-2-：内存管理/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>Author</div>
          <div>Nuoyan Chen</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>Posted on</div>
          <div>October 21, 2025</div>
        </div>
      
      
      
        <div class="license-meta-item">
          <div>Licensed under</div>
          <div>
            
              
              
                <a class="print-no-link" target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
                  <span class="hint--top hint--rounded" aria-label="BY - Attribution">
                    <i class="iconfont icon-cc-by"></i>
                  </span>
                </a>
              
            
          </div>
        </div>
      
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
                <div class="post-prevnext my-3">
                  <article class="post-prev col-6">
                    
                    
                  </article>
                  <article class="post-next col-6">
                    
                    
                      <a href="/2025/10/02/%E6%93%8D%E4%BD%9C%E7%B3%BB%E7%BB%9F-SJTU-%E7%89%88-1-%EF%BC%9A%E6%A6%82%E8%BF%B0/" title="操作系统 SJTU 版(1)：概述">
                        <span class="hidden-mobile">操作系统 SJTU 版(1)：概述</span>
                        <span class="visible-mobile">Next</span>
                        <i class="iconfont icon-arrowright"></i>
                      </a>
                    
                  </article>
                </div>
              
            </div>

            
  
  
    <article id="comments" lazyload>
      
    <div id="giscus" class="giscus"></div>
    <script type="text/javascript">
      Fluid.utils.loadComments('#giscus', function() {
        var options = {"repo":"cny123222/cny123222.github.io","repo-id":"R_kgDOOFgnVw","category":"Announcements","category-id":"DIC_kwDOOFgnV84CnwXM","theme-light":"light","theme-dark":"dark","mapping":"pathname","reactions-enabled":1,"emit-metadata":0,"input-position":"top","lang":"en"};
        var attributes = {};
        for (let option in options) {
          if (!option.startsWith('theme-')) {
            var key = option.startsWith('data-') ? option : 'data-' + option;
            attributes[key] = options[option];
          }
        }
        var light = 'light';
        var dark = 'dark';
        window.GiscusThemeLight = light;
        window.GiscusThemeDark = dark;
        attributes['data-theme'] = document.documentElement.getAttribute('data-user-color-scheme') === 'dark' ? dark : light;
        for (let attribute in attributes) {
          var value = attributes[attribute];
          if (value === undefined || value === null || value === '') {
            delete attributes[attribute];
          }
        }
        var s = document.createElement('script');
        s.setAttribute('src', 'https://giscus.app/client.js');
        s.setAttribute('crossorigin', 'anonymous');
        for (let attribute in attributes) {
          s.setAttribute(attribute, attributes[attribute]);
        }
        var ss = document.getElementsByTagName('script');
        var e = ss.length > 0 ? ss[ss.length - 1] : document.head || document.documentElement;
        e.parentNode.insertBefore(s, e.nextSibling);
      });
    </script>
    <noscript>Please enable JavaScript to view the comments</noscript>


    </article>
  


          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header">
    <i class="iconfont icon-list"></i>
    <span>Table of Contents</span>
  </p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  



  


  
  




  <script>
  Fluid.utils.createScript('https://lib.baomitu.com/mermaid/8.14.0/mermaid.min.js', function() {
    mermaid.initialize({"theme":"default"});

    Fluid.utils.listenDOMLoaded(function() {
      Fluid.events.registerRefreshCallback(function() {
        if ('mermaid' in window) {
          mermaid.init();
        }
      });
    });
  });
</script>






    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    
      <div class="modal fade" id="modalSearch" tabindex="-1" role="dialog" aria-labelledby="ModalLabel"
     aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable modal-lg" role="document">
    <div class="modal-content">
      <div class="modal-header text-center">
        <h4 class="modal-title w-100 font-weight-bold">Search</h4>
        <button type="button" id="local-search-close" class="close" data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body mx-3">
        <div class="md-form mb-5">
          <input type="text" id="local-search-input" class="form-control validate">
          <label data-error="x" data-success="v" for="local-search-input">Keyword</label>
        </div>
        <div class="list-group" id="local-search-result"></div>
      </div>
    </div>
  </div>
</div>

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
  
    <div class="statistics">
  
  

  
    
      <span id="busuanzi_container_site_pv" style="display: none">
        Views: 
        <span id="busuanzi_value_site_pv"></span>
        
      </span>
    
    
      <span id="busuanzi_container_site_uv" style="display: none">
        Visitors: 
        <span id="busuanzi_value_site_uv"></span>
        
      </span>
    
    

  

</div>

  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.4/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.20.1/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init(Object.assign({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      scrollSmooth    : true,
      includeTitleTags: true,
      headingsOffset  : -boardTop,
    }, CONFIG.toc));
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }

    Fluid.events.registerRefreshCallback(function() {
      if ('tocbot' in window) {
        tocbot.refresh();
        var toc = jQuery('#toc');
        if (toc.length === 0 || !tocbot) {
          return;
        }
        if (toc.find('.toc-list-item').length > 0) {
          toc.css('visibility', 'visible');
        }
      }
    });
  });
</script>


  <script src=https://lib.baomitu.com/clipboard.js/2.0.11/clipboard.min.js></script>

  <script>Fluid.plugins.codeWidget();</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/5.0.0/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));

    Fluid.events.registerRefreshCallback(function() {
      if ('anchors' in window) {
        anchors.removeAll();
        var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
        var res = [];
        for (var item of el) {
          res.push('.markdown-body > ' + item.trim());
        }
        if (CONFIG.anchorjs.placement === 'left') {
          anchors.options.class = 'anchorjs-link-left';
        }
        anchors.add(res.join(', '));
      }
    });
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>


  <script>Fluid.plugins.imageCaption();</script>

  <script  src="/js/local-search.js" ></script>

  <script defer src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" ></script>





<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">Blog works best with JavaScript enabled</div>
  </noscript>
</body>
</html>
